<!-- app/views/expenses/_form.html.erb -->
<%= form_with(model: [@trip, @expense]) do |form| %>
  <% if @expense.errors.any? %>
    <div id="error_explanation">
      <h2><%= pluralize(@expense.errors.count, "error") %> prohibited this expense from being saved:</h2>
      <ul>
        <% @expense.errors.full_messages.each do |message| %>
          <li><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <%= form.hidden_field :trip_id, value: @trip.id %>

  <div>
    <%= form.label :description %>
    <%= form.text_field :description %>
  </div>

  <div>
    <%= form.label :t_amount %>
    <%= form.text_field :t_amount %>
  </div>

  <div>
    <%= form.label :expense_date %>
    <%= form.date_field :expense_date %>
  </div>

  <div>
    <%= form.label :categories %>
    <%= form.select :categories, options_for_select(["Food", "Transportation", "Lodging", "Entertainment", "Misc"]) %>
  </div>

  <div class="form-field">
    <%= form.label :include_all_trip_participants, "Include all trip participants" %>
    <%= form.check_box :include_all_trip_participants %>
  </div>

  <div>
    <%= form.submit %>
  </div>
<% end %>

<!-- Form to Add Participants -->
<% if !@expense.new_record? %>
  <h3>Add Participant by Email</h3>
  <%= form_with url: add_participant_expense_path(@expense), method: :post, local: true do |form| %>
    <div class="field">
      <%= form.label :participant_email, "Add Participant by Email" %>
      <%= form.text_field :participant_email, placeholder: "Enter participant email" %>
      <%= form.submit "Add", class: "button add-participant-button" %>
    </div>
  <% end %>
  <!-- List of Current Participants with Remove Option -->
  <div class="current-participants">
    <h3>Current Participants:</h3>
    <% if @expense.participants.any? %>
      <ul>
        <% @expense.participants.each do |participant| %>
          <li>
            <strong>Email:</strong> <%= participant.email %>
            <% if participant.first_name.present? %>
              <strong>Name:</strong> <%= participant.first_name %> <%= participant.last_name %>
            <% end %>
            
            <%= form_with url: remove_participant_expense_path(@expense), method: :post, local: true do |f| %>
              <%= hidden_field_tag :participant_email, participant.email %>
              <%= f.submit 'Remove Participant', data: { confirm: 'Are you sure you want to remove this participant?' }, class: 'remove-participant-button' %>
            <% end %>
          </li>
        <% end %>
      </ul>
    <% else %>
      <p>No participants added yet.</p>
    <% end %>
  </div>
<% end %>
